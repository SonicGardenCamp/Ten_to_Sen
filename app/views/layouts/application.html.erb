<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Camp Ten To Sen" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
  </head>

  <body>
    <div class="titlecontainer">
      <div class="titlemenubox">
        <% if controller_name == "rooms" %>
          <% if action_name == "index" %>
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã§ã®ã¿BGMãƒœã‚¿ãƒ³ã‚’å·¦å´ã«è¿½åŠ  -->
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
              <!-- å·¦å´ï¼šBGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
              <div style="display: flex; gap: 10px; align-items: center;">
                <button id="bgm-toggle" class="logout-btn">ğŸ”Š BGM</button>
                <button id="bgm-next" class="logout-btn">â­ï¸</button>
              </div>

              <!-- å³å´ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
              <div class="greeting">
                <% if current_user %>
                  ã“ã‚“ã«ã¡ã¯ã€<%= current_user.username %> ã•ã‚“
                  <%= button_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_user_session_path, method: :delete, class: "logout-btn" %>
                <% else %>
                  ã‚²ã‚¹ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ä¸­ã§ã™
                <% end %>
              </div>
            </div>
          <% else %>
            <!-- rooms#indexä»¥å¤–ã§ã¯å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
            <div class="greeting">
              <% if current_user %>
                ã“ã‚“ã«ã¡ã¯ã€<%= current_user.username %> ã•ã‚“
                <%= button_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_user_session_path, method: :delete, class: "logout-btn" %>
              <% else %>
                ã‚²ã‚¹ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ä¸­ã§ã™
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
    <div class="titletext">
        <h3 class="titletext_sub2"> é«˜é€Ÿã—ã‚Šã¨ã‚Šãƒãƒˆãƒ« </h3>
        <h1 class="titletext_sub"> WORD CHASER </h1>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã§ã®ã¿BGMç”¨ã®audioã‚¿ã‚°ã‚’è¡¨ç¤º -->
    <% if controller_name == "rooms" && action_name == "index" %>
      <audio id="bgm-player" preload="auto" style="display: none;">
      </audio>
    <% end %>

    <%= yield %>
  </body>
</html>

<% if controller_name == "rooms" && action_name == "index" %>
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªBGMç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
window.BGMManager = window.BGMManager || (function() {
  const bgmList = [
    '<%= asset_path('bgm1.mp3') %>',
    '<%= asset_path('bgm2.mp3') %>',
    '<%= asset_path('bgm3.mp3') %>'
  ];

  let currentTrack = 0;
  let isPlaying = false;
  let audioPlayer = null;
  let toggleButton = null;
  let nextButton = null;
  let isInitialized = false;

  function initialize() {
    if (isInitialized) return;

    audioPlayer = document.getElementById('bgm-player');
    toggleButton = document.getElementById('bgm-toggle');
    nextButton = document.getElementById('bgm-next');

    if (!audioPlayer || !toggleButton || !nextButton) {
      console.log('BGM elements not found, retrying...');
      setTimeout(initialize, 100);
      return;
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’å–å¾—
    const savedVolume = localStorage.getItem('bgmVolume') || '0.3';
    const savedMuted = localStorage.getItem('bgmMuted') === 'true';
    const savedTrack = parseInt(localStorage.getItem('bgmCurrentTrack')) || 0;
    const wasPlaying = localStorage.getItem('bgmWasPlaying') === 'true';

    // è¨­å®šã‚’é©ç”¨
    audioPlayer.volume = parseFloat(savedVolume);
    audioPlayer.muted = savedMuted;
    currentTrack = savedTrack;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    setupEventListeners();

    // åˆæœŸãƒˆãƒ©ãƒƒã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰
    loadTrack(currentTrack);

    // å‰å›å†ç”Ÿä¸­ã ã£ãŸå ´åˆã¯å†é–‹ã‚’è©¦è¡Œ
    if (wasPlaying && !savedMuted) {
      setTimeout(() => {
        startPlayback();
      }, 500);
    }

    updateToggleButton();
    isInitialized = true;
    console.log('BGM Manager initialized');
  }

  function setupEventListeners() {
    // æ›²çµ‚äº†æ™‚ã®å‡¦ç†
    audioPlayer.addEventListener('ended', function() {
      console.log('Track ended, playing next');
      nextTrack();
    });

    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
    audioPlayer.addEventListener('error', function(e) {
      console.error('Audio error:', e);
      setTimeout(() => {
        nextTrack();
      }, 1000);
    });

    // å†ç”Ÿ/ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³
    toggleButton.addEventListener('click', function() {
      if (isPlaying && !audioPlayer.muted) {
        // ãƒŸãƒ¥ãƒ¼ãƒˆ
        audioPlayer.muted = true;
        localStorage.setItem('bgmMuted', 'true');
      } else if (isPlaying && audioPlayer.muted) {
        // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
        audioPlayer.muted = false;
        localStorage.setItem('bgmMuted', 'false');
      } else {
        // å†ç”Ÿé–‹å§‹
        startPlayback();
      }
      updateToggleButton();
    });

    // æ¬¡ã®æ›²ãƒœã‚¿ãƒ³
    nextButton.addEventListener('click', function() {
      nextTrack();
    });

    // éŸ³é‡å¤‰æ›´æ™‚ã®ä¿å­˜
    audioPlayer.addEventListener('volumechange', function() {
      localStorage.setItem('bgmVolume', audioPlayer.volume.toString());
    });

    // å†ç”ŸçŠ¶æ…‹å¤‰æ›´æ™‚ã®ä¿å­˜
    audioPlayer.addEventListener('play', function() {
      isPlaying = true;
      localStorage.setItem('bgmWasPlaying', 'true');
      updateToggleButton();
    });

    audioPlayer.addEventListener('pause', function() {
      isPlaying = false;
      localStorage.setItem('bgmWasPlaying', 'false');
      updateToggleButton();
    });
  }

  function loadTrack(index) {
    if (bgmList.length === 0) return;

    currentTrack = index % bgmList.length;
    audioPlayer.src = bgmList[currentTrack];
    localStorage.setItem('bgmCurrentTrack', currentTrack.toString());
    console.log('Loading track:', bgmList[currentTrack]);
  }

  function startPlayback() {
    if (!audioPlayer) return;

    audioPlayer.muted = false;
    audioPlayer.play().then(() => {
      isPlaying = true;
      localStorage.setItem('bgmMuted', 'false');
      localStorage.setItem('bgmWasPlaying', 'true');
      console.log('BGM playback started');
    }).catch(error => {
      console.log('Playback failed:', error);
      isPlaying = false;
    });
  }

  function nextTrack() {
    const wasPlayingBeforeNext = isPlaying;
    currentTrack = (currentTrack + 1) % bgmList.length;
    loadTrack(currentTrack);

    if (wasPlayingBeforeNext && !audioPlayer.muted) {
      audioPlayer.play().catch(error => {
        console.error('Error playing next track:', error);
      });
    }
  }

  function updateToggleButton() {
    if (!toggleButton) return;

    if (audioPlayer.muted || !isPlaying) {
      toggleButton.textContent = 'ğŸ”‡ BGM';
      toggleButton.classList.remove('btn-secondary');
      toggleButton.classList.add('btn-outline-secondary');
    } else {
      toggleButton.textContent = 'ğŸ”Š BGM';
      toggleButton.classList.remove('btn-outline-secondary');
      toggleButton.classList.add('btn-secondary');
    }
  }

  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®å‡¦ç†
  window.addEventListener('beforeunload', function() {
    if (audioPlayer && !audioPlayer.paused) {
      localStorage.setItem('bgmWasPlaying', 'true');
    }
  });

  // å…¬é–‹API
  return {
    initialize: initialize,
    isInitialized: () => isInitialized
  };
})();

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing BGM...');
  BGMManager.initialize();
});

// Turboå¯¾å¿œï¼ˆRails 7ã®Turboã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆï¼‰
document.addEventListener('turbo:load', function() {
  console.log('Turbo loaded, reinitializing BGM...');
  setTimeout(() => {
    BGMManager.initialize();
  }, 100);
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã®è‡ªå‹•å†ç”Ÿè©¦è¡Œ
let hasTriedAutoplay = false;
document.addEventListener('click', function() {
  if (!hasTriedAutoplay && BGMManager.isInitialized()) {
    hasTriedAutoplay = true;
    const wasPlaying = localStorage.getItem('bgmWasPlaying') === 'true';
    const muted = localStorage.getItem('bgmMuted') === 'true';

    if (wasPlaying && !muted) {
      const audioPlayer = document.getElementById('bgm-player');
      if (audioPlayer && audioPlayer.paused) {
        audioPlayer.play().catch(console.error);
      }
    }
  }
}, { once: true });
</script>

<style>
/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç¸¦ä¸¦ã³ã« */
  .titlecontainer .titlemenubox > div:first-child {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }

  .titlecontainer .titlemenubox .greeting {
    align-self: flex-end;
  }
}
</style>
<% end %>
